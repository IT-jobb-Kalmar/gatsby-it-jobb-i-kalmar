language: node_js
node_js:
- node
cache:
  directories:
  - node_modules
before_install:
- sudo add-apt-repository ppa:duggan/bats --yes
- sudo apt-get update -qq
- sudo apt-get install -qq bats python-pip python-setuptools
- sudo pip install awscli
- aws s3 rm s3://it-jobb-i-kalmar --recursive --region eu-central-1
install:
- npm i -g gatsby
- npm install
script:
- npm run build --dd
deploy:
  provider: s3
  access_key_id: AKIAJRNJAWH5WTT2BZFA
  secret_access_key:
    secure: qOpjUR1aIb2g4IRhJ+fbTxAuwsZ9pUPEw1KaesGQo6j1Ufj41rhb9ATfeEYc84NQCrxYdXBcYpN3AvY/LGegPGXLtaEQ4DncIeiqNOPnxT5pJW1QoManf582K3mMnXtWv20X9ftMQWM7mtCIN9q/cXeSKVn9iV2jPMang5ZtumjCF17501iLY0S8SlCIqDHRqEX6LjOKRmII+6k0yxHpSMwHuhWjMVqVmzHi7ZPrSFjK2FX1isx5qxM19WXXxIMGu9Yg+Eb2RgzniSMbsGO0/GUGTMm+Tvcpie27gBQGnQNpaWgjRe8TYKXiK1vvzS4CpMQwFjl6V2oqWRJBoKmJa2FdmrQh7k1SUkJbt9CaACIMaFUH9kg9kVBnRqouw9hjyKOL0zgoGlCkDIpR0HFX7yTMOtAc6xUue/NLbujSRdj1+kl46B+Vw5sYxCuqd6YBS0D+Hrw0ZDaubxoPNVSwqfoWeqn0oudzw7V94W8cZl0eFMGvKl3j59M0fV5nsNrXeiyFUjEgB4yaR/LPei1Wo0G4m1ARNHa6/JQ62ORf7ZsLS1oIMkZmhyZAWNnBG2F4vMgISahuRzkx18nHsXB4Z+4VjbSpQG9NoadG53jsvT0Q0KANfidW2k+FDp4TxyOhNgl1ZTjsqG7waLTmUcj1hC6Jk3AiCKFFOqxonWqumxs=
  bucket: it-jobb-i-kalmar
  local-dir: public
  acl: public_read
  region: eu-west-1
  skip_cleanup: true
  on:
    repo: IT-jobb-Kalmar/gatsby-it-jobb-i-kalmar
after_deploy:
- aws configure set preview.cloudfront true
- aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DISTRIBUTION_ID
  --paths "/*"
branches:
  only:
  - master
